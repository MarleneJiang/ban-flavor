name: Build and Sign (Advanced)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-sign:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        
    # å¯é€‰ï¼šå¦‚æœéœ€è¦ä»£ç ç­¾åï¼Œè¯·é…ç½®ä»¥ä¸‹æ­¥éª¤
    # - name: Import Code-Signing Certificates
    #   uses: Apple-Actions/import-codesign-certs@v1
    #   with:
    #     p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
    #     p12-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
        
    - name: Install dependencies
      run: |
        flutter pub get
        cd macos && pod install && cd ..
        
    - name: Build macOS app (Release)
      run: |
        flutter build macos --release
        
    # å¯é€‰ï¼šä»£ç ç­¾åæ­¥éª¤ï¼ˆéœ€è¦Apple Developerè´¦å·ï¼‰
    # - name: Code Sign App
    #   run: |
    #     codesign --force --deep --sign "${{ secrets.DEVELOPER_ID_APPLICATION }}" \
    #       build/macos/Build/Products/Release/ban_flavor_detector.app
        
    - name: Create installer package
      run: |
        # åˆ›å»ºæ›´ä¸“ä¸šçš„å®‰è£…åŒ…
        mkdir -p installer/Applications
        cp -R build/macos/Build/Products/Release/ban_flavor_detector.app installer/
        
        # åˆ›å»ºå®‰è£…è„šæœ¬
        cat > installer/install.sh << 'EOF'
        #!/bin/bash
        echo "æ­£åœ¨å®‰è£…ç­å‘³æ£€æµ‹å™¨..."
        cp -R ban_flavor_detector.app /Applications/
        echo "å®‰è£…å®Œæˆï¼æ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ç­å‘³æ£€æµ‹å™¨ã€‚"
        EOF
        chmod +x installer/install.sh
        
        # åˆ›å»ºå¸è½½è„šæœ¬
        cat > installer/uninstall.sh << 'EOF'
        #!/bin/bash
        echo "æ­£åœ¨å¸è½½ç­å‘³æ£€æµ‹å™¨..."
        rm -rf /Applications/ban_flavor_detector.app
        rm -rf ~/Documents/DailyPhotos
        echo "å¸è½½å®Œæˆï¼"
        EOF
        chmod +x installer/uninstall.sh
        
        # åˆ›å»ºREADME
        cat > installer/README.txt << 'EOF'
        ç­å‘³æ£€æµ‹å™¨ macOS ç‰ˆæœ¬
        
        å®‰è£…è¯´æ˜ï¼š
        1. åŒå‡»è¿è¡Œ install.sh è¿›è¡Œå®‰è£…
        2. æˆ–è€…æ‰‹åŠ¨å°† ban_flavor_detector.app æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
        
        å¸è½½è¯´æ˜ï¼š
        - è¿è¡Œ uninstall.sh å®Œå…¨å¸è½½åº”ç”¨å’Œæ•°æ®
        
        ç³»ç»Ÿè¦æ±‚ï¼š
        - macOS 10.15 æˆ–æ›´é«˜ç‰ˆæœ¬
        - æ‘„åƒå¤´æƒé™
        
        é¦–æ¬¡ä½¿ç”¨ï¼š
        1. å¯åŠ¨åº”ç”¨åæˆæƒæ‘„åƒå¤´æƒé™
        2. å¯é€‰æ‹©æ˜¯å¦å¼€æœºè‡ªå¯åŠ¨
        3. åº”ç”¨å°†åœ¨åå°è¿è¡Œï¼Œæ¯æ—¥é¦–æ¬¡è§£é”æ—¶è‡ªåŠ¨æ‹ç…§
        
        é—®é¢˜åé¦ˆï¼šhttps://github.com/MarleneJiang/ban-flavor/issues
        EOF
        
    - name: Create DMG with installer
      run: |
        # ä½¿ç”¨ create-dmg åˆ›å»ºæ›´ä¸“ä¸šçš„ DMG
        brew install create-dmg
        
        create-dmg \
          --volname "ç­å‘³æ£€æµ‹å™¨å®‰è£…åŒ…" \
          --volicon "installer/ban_flavor_detector.app/Contents/Resources/AppIcon.icns" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "ban_flavor_detector.app" 175 120 \
          --hide-extension "ban_flavor_detector.app" \
          --app-drop-link 425 120 \
          --add-file "å®‰è£…è„šæœ¬" "installer/install.sh" 175 250 \
          --add-file "å¸è½½è„šæœ¬" "installer/uninstall.sh" 325 250 \
          --add-file "ä½¿ç”¨è¯´æ˜" "installer/README.txt" 475 250 \
          "ç­å‘³æ£€æµ‹å™¨-${GITHUB_REF_NAME:-latest}-macos.dmg" \
          "installer/" || {
            # å¦‚æœ create-dmg å¤±è´¥ï¼Œä½¿ç”¨ hdiutil ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
            echo "create-dmg failed, using hdiutil..."
            hdiutil create -volname "ç­å‘³æ£€æµ‹å™¨" \
              -srcfolder installer \
              -ov -format UDZO \
              "ç­å‘³æ£€æµ‹å™¨-${GITHUB_REF_NAME:-latest}-macos.dmg"
          }
          
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-installer-${{ github.sha }}
        path: |
          ç­å‘³æ£€æµ‹å™¨-*.dmg
          installer/
        retention-days: 90
        
    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ç­å‘³æ£€æµ‹å™¨-*.dmg
        body: |
          ## ğŸ­ ç­å‘³æ£€æµ‹å™¨ - ${{ github.ref_name }}
          
          > **ä¸“ä¸šç‰ˆå®‰è£…åŒ…ï¼ŒåŒ…å«å®Œæ•´çš„å®‰è£…å’Œå¸è½½è„šæœ¬**
          
          ### ğŸ“¦ å®‰è£…æ–¹å¼
          
          **æ–¹å¼ä¸€ï¼šè‡ªåŠ¨å®‰è£…ï¼ˆæ¨èï¼‰**
          1. ä¸‹è½½å¹¶æ‰“å¼€ DMG æ–‡ä»¶
          2. åŒå‡»è¿è¡Œ"å®‰è£…è„šæœ¬"
          3. æŒ‰æç¤ºå®Œæˆå®‰è£…
          
          **æ–¹å¼äºŒï¼šæ‰‹åŠ¨å®‰è£…**
          1. ä¸‹è½½å¹¶æ‰“å¼€ DMG æ–‡ä»¶  
          2. å°†åº”ç”¨æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
          3. åœ¨å¯åŠ¨å°ä¸­æ‰¾åˆ°å¹¶å¯åŠ¨åº”ç”¨
          
          ### âœ¨ æ–°ç‰ˆæœ¬ç‰¹æ€§
          - ğŸš€ æ›´ç¨³å®šçš„åå°è¿è¡Œæœºåˆ¶
          - ğŸ¨ ä¼˜åŒ–çš„ç”¨æˆ·ç•Œé¢ä½“éªŒ
          - ğŸ“¸ æ”¹è¿›çš„æ‹ç…§è´¨é‡å’Œå‹ç¼©ç®—æ³•
          - âš™ï¸ å¢å¼ºçš„ç³»ç»Ÿé›†æˆåŠŸèƒ½
          
          ### ğŸ”§ ä½¿ç”¨æŒ‡å—
          1. **é¦–æ¬¡å¯åŠ¨**ï¼šæˆæƒæ‘„åƒå¤´å’Œæ–‡ä»¶è®¿é—®æƒé™
          2. **å¼€æœºå¯åŠ¨**ï¼šåœ¨è®¾ç½®ä¸­å¯ç”¨è‡ªåŠ¨å¯åŠ¨åŠŸèƒ½  
          3. **æŸ¥çœ‹ç…§ç‰‡**ï¼šç‚¹å‡»ç”»å»ŠæŸ¥çœ‹æ¯æ—¥æ‹æ‘„çš„ç…§ç‰‡
          4. **æ•°æ®ç®¡ç†**ï¼šåœ¨è®¾ç½®ä¸­ç®¡ç†ç…§ç‰‡å­˜å‚¨å’Œå¯¼å‡º
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - **æ“ä½œç³»ç»Ÿ**ï¼šmacOS 10.15+ (Catalina æˆ–æ›´é«˜ç‰ˆæœ¬)
          - **ç¡¬ä»¶è¦æ±‚**ï¼šå†…ç½®æˆ–å¤–æ¥æ‘„åƒå¤´
          - **å­˜å‚¨ç©ºé—´**ï¼šå»ºè®®é¢„ç•™ 100MB ä»¥ä¸Šç©ºé—´
          
          ### ğŸ› ï¸ æ•…éšœæ’é™¤
          - **æƒé™é—®é¢˜**ï¼šåœ¨ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ä¸­æ£€æŸ¥æƒé™
          - **æ— æ³•å¯åŠ¨**ï¼šå°è¯•åœ¨ç»ˆç«¯è¿è¡Œ `sudo xattr -rd com.apple.quarantine /Applications/ban_flavor_detector.app`
          - **å¸è½½åº”ç”¨**ï¼šè¿è¡Œ DMG ä¸­çš„"å¸è½½è„šæœ¬"æˆ–æ‰‹åŠ¨åˆ é™¤åº”ç”¨
          
          ### ğŸ› é—®é¢˜åé¦ˆ
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/MarleneJiang/ban-flavor/issues) ä¸­åé¦ˆã€‚
          
          ---
          
          **ğŸ­ è®©æ¯ä¸€å¤©çš„å·¥ä½œéƒ½å°‘ç‚¹ç­å‘³ï¼**
          
          *Built with â¤ï¸ using Flutter + GitHub Actions*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
