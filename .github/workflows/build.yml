name: Build and Release

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        
    - name: Install dependencies
      run: |
        flutter --version
        flutter pub get
        
    - name: Setup CocoaPods
      run: |
        cd macos
        pod install
        cd ..
        
    - name: Run tests
      run: flutter test
      
    - name: Build macOS app
      run: |
        flutter build macos --release
        
    - name: Create DMG (macOS Installer)
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºDMGæ„å»º
        mkdir -p dmg_temp
        
        # å¤åˆ¶åº”ç”¨åˆ°ä¸´æ—¶ç›®å½•
        cp -R build/macos/Build/Products/Release/ban_flavor_detector.app dmg_temp/
        
        # åˆ›å»ºåº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹çš„ç¬¦å·é“¾æ¥
        ln -s /Applications dmg_temp/Applications
        
        # åˆ›å»ºDMGæ–‡ä»¶
        hdiutil create -volname "ç­å‘³æ£€æµ‹å™¨" \
          -srcfolder dmg_temp \
          -ov -format UDZO \
          "ç­å‘³æ£€æµ‹å™¨-macos.dmg"
          
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-build-${{ github.sha }}
        path: |
          build/macos/Build/Products/Release/ban_flavor_detector.app
          ç­å‘³æ£€æµ‹å™¨-macos.dmg
        retention-days: 30
        
    - name: Upload to Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ç­å‘³æ£€æµ‹å™¨-macos.dmg
        body: |
          ## ğŸ­ ç­å‘³æ£€æµ‹å™¨ - ${{ github.ref_name }}
          
          ### ğŸ“¦ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ `ç­å‘³æ£€æµ‹å™¨-macos.dmg` æ–‡ä»¶
          2. åŒå‡»æ‰“å¼€ DMG æ–‡ä»¶
          3. å°†åº”ç”¨æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
          4. åœ¨ Applications ä¸­å¯åŠ¨åº”ç”¨
          5. é¦–æ¬¡å¯åŠ¨æ—¶éœ€è¦æˆæƒæ‘„åƒå¤´æƒé™
          
          ### âœ¨ åŠŸèƒ½ç‰¹è‰²
          - ğŸ¤– æ¯æ—¥é¦–æ¬¡è§£é”è‡ªåŠ¨æ‹ç…§
          - ğŸ–¼ï¸ æ—¶é—´çº¿ç…§ç‰‡ç”»å»Š
          - âš™ï¸ å¼€æœºè‡ªå¯åŠ¨é…ç½®
          - ğŸ¨ æŠ½è±¡è‰ºæœ¯é£æ ¼ç•Œé¢
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - macOS 10.15+ (Catalina æˆ–æ›´é«˜ç‰ˆæœ¬)
          - æ‘„åƒå¤´è®¾å¤‡
          
          ### ğŸ”§ ä½¿ç”¨è¯´æ˜
          åº”ç”¨ä¼šåœ¨åå°é™é»˜è¿è¡Œï¼Œæ¯å¤©ç¬¬ä¸€æ¬¡è§£é”ç”µè„‘æ—¶è‡ªåŠ¨æ‹ç…§ï¼Œè®°å½•æ‚¨çš„"ç­å‘³"å˜åŒ–ã€‚
          
          ---
          Built with â¤ï¸ using Flutter + GitHub Actions
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
